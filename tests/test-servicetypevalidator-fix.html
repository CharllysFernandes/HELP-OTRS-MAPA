<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test ServiceTypeValidator - Help OTRS</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 900px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .Field {
            margin: 10px 0;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        select, input {
            width: 200px;
            padding: 5px;
            margin-bottom: 10px;
        }
        .test-controls {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-primary { background: #007cba; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        
        .scenario {
            background: #f8f9fa;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #007cba;
        }

        .status-panel {
            background: #f8f9fa;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 15px 0;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }

        .status-value {
            font-weight: bold;
        }

        .error-log {
            background: #fff5f5;
            border: 1px solid #feb2b2;
            color: #c53030;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üõ†Ô∏è Test ServiceTypeValidator Fix</h1>
        <p>Este teste verifica se as corre√ß√µes do m√©todo <code>showServiceTypeQueueAlert</code> est√£o funcionando corretamente.</p>

        <div class="form-section">
            <h3>Simula√ß√£o de Formul√°rio OTRS</h3>
            
            <div class="Field">
                <label for="Dest">Fila (Queue):</label>
                <select id="Dest" name="Dest">
                    <option value="">-- Selecione uma fila --</option>
                    <option value="T√©cnico Local">T√©cnico Local</option>
                    <option value="T√©cnico Remoto">T√©cnico Remoto</option>
                    <option value="Suporte Presencial">Suporte Presencial</option>
                    <option value="Atendimento Remoto">Atendimento Remoto</option>
                    <option value="Helpdesk">Helpdesk</option>
                </select>
            </div>

            <div class="Field">
                <label for="DynamicField_PRITipoAtendimento">Tipo de Atendimento:</label>
                <select id="DynamicField_PRITipoAtendimento" name="DynamicField_PRITipoAtendimento">
                    <option value="">-- Selecione o tipo --</option>
                    <option value="Presencial">Presencial</option>
                    <option value="Remoto">Remoto</option>
                </select>
            </div>

            <div class="Field">
                <label for="ServiceID">Classifica√ß√£o do Servi√ßo:</label>
                <select id="ServiceID" name="ServiceID">
                    <option value="">-- Selecione a classifica√ß√£o --</option>
                    <option value="1">Suporte T√©cnico</option>
                    <option value="2">Manuten√ß√£o</option>
                    <option value="3">Instala√ß√£o</option>
                </select>
            </div>
        </div>

        <div class="status-panel">
            <h3>üìä Status Atual</h3>
            <div class="status-item">
                <span>Fila Selecionada:</span>
                <span class="status-value" id="currentQueue">-</span>
            </div>
            <div class="status-item">
                <span>Tipo de Atendimento:</span>
                <span class="status-value" id="currentServiceType">-</span>
            </div>
            <div class="status-item">
                <span>Classifica√ß√£o:</span>
                <span class="status-value" id="currentService">-</span>
            </div>
        </div>

        <div class="test-controls">
            <h3>üß™ Testes do ServiceTypeValidator</h3>
            
            <div class="scenario">
                <strong>Inicializa√ß√£o:</strong>
                <button class="btn-primary" onclick="initializeValidator()">
                    üöÄ Inicializar ServiceTypeValidator
                </button>
                <button class="btn-success" onclick="runAllValidations()">
                    ‚úÖ Executar Todas as Valida√ß√µes
                </button>
            </div>

            <div class="scenario">
                <strong>Valida√ß√µes Espec√≠ficas:</strong>
                <button class="btn-warning" onclick="validateTechnicalLocal()">
                    üîß Validar T√©cnico Local
                </button>
                <button class="btn-warning" onclick="validateTechnicalRemote()">
                    üåê Validar T√©cnico Remoto
                </button>
                <button class="btn-warning" onclick="validateServiceType()">
                    üìã Validar Tipo de Servi√ßo
                </button>
            </div>

            <div class="scenario">
                <strong>Cen√°rios de Teste:</strong>
                <button class="btn-success" onclick="testScenario('T√©cnico Local', 'Presencial')">
                    ‚úÖ Cen√°rio Consistente (Local/Presencial)
                </button>
                <button class="btn-danger" onclick="testScenario('T√©cnico Local', 'Remoto')">
                    ‚ùå Cen√°rio Inconsistente (Local/Remoto)
                </button>
                <button class="btn-danger" onclick="testScenario('T√©cnico Remoto', 'Presencial')">
                    ‚ùå Cen√°rio Inconsistente (Remoto/Presencial)
                </button>
            </div>

            <div class="scenario">
                <strong>Controles:</strong>
                <button class="btn-primary" onclick="clearAllAlerts()">üóëÔ∏è Limpar Alertas</button>
                <button class="btn-primary" onclick="clearLog()">üìù Limpar Log</button>
            </div>
        </div>

        <div class="test-controls">
            <h3>üìä Log de Sistema</h3>
            <div id="testLog" style="background: #f8f9fa; padding: 10px; border: 1px solid #ddd; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>
            <button class="btn-primary" onclick="exportLog()">üíæ Exportar Log</button>
        </div>

        <div id="errorContainer" style="display: none;">
            <h3>üö® Erros Encontrados</h3>
            <div id="errorLog" class="error-log"></div>
        </div>
    </div>

    <!-- Scripts Help OTRS -->
    <script src="src/core/AlertSystem.js"></script>
    <script src="src/core/ConfigManager.js"></script>
    <script src="src/modules/QueueValidator.js"></script>
    <script src="src/modules/ServiceTypeValidator.js"></script>
    <script>
        // Vari√°veis globais
        let alertSystem = null;
        let configManager = null;
        let queueValidator = null;
        let serviceTypeValidator = null;

        // Log de teste
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const typeColor = {
                'info': '#007cba',
                'success': '#28a745',
                'warning': '#ffc107',
                'error': '#dc3545'
            };
            
            logDiv.innerHTML += `<div style="color: ${typeColor[type] || '#000'};">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function logError(message, error) {
            log(`‚ùå ${message}: ${error.message}`, 'error');
            
            const errorContainer = document.getElementById('errorContainer');
            const errorLog = document.getElementById('errorLog');
            
            errorContainer.style.display = 'block';
            errorLog.innerHTML += `[${new Date().toLocaleTimeString()}] ${message}\n${error.stack}\n\n`;
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
            document.getElementById('errorContainer').style.display = 'none';
            document.getElementById('errorLog').innerHTML = '';
        }

        function exportLog() {
            const logContent = document.getElementById('testLog').innerText;
            const errorContent = document.getElementById('errorLog').innerText;
            
            const fullLog = `=== LOG DE TESTE ServiceTypeValidator ===\n${new Date().toISOString()}\n\n` +
                           `=== LOG PRINCIPAL ===\n${logContent}\n\n` +
                           `=== ERROS ===\n${errorContent}`;
            
            const blob = new Blob([fullLog], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `servicetypevalidator-test-${new Date().getTime()}.log`;
            a.click();
            
            URL.revokeObjectURL(url);
        }

        // Atualizar status na interface
        function updateStatus() {
            try {
                const queue = document.querySelector('#Dest')?.value || '-';
                const serviceType = document.querySelector('#DynamicField_PRITipoAtendimento')?.value || '-';
                const service = document.querySelector('#ServiceID')?.value || '-';
                
                document.getElementById('currentQueue').textContent = queue;
                document.getElementById('currentServiceType').textContent = serviceType;
                document.getElementById('currentService').textContent = service;
            } catch (error) {
                logError('Erro ao atualizar status', error);
            }
        }

        // Configurar cen√°rio de teste
        function testScenario(queueValue, serviceTypeValue, serviceValue = '1') {
            log(`üß™ Configurando cen√°rio: Queue="${queueValue}", Type="${serviceTypeValue}", Service="${serviceValue}"`, 'info');
            
            try {
                const queueSelect = document.querySelector('#Dest');
                const serviceSelect = document.querySelector('#DynamicField_PRITipoAtendimento');
                const classSelect = document.querySelector('#ServiceID');
                
                if (queueSelect) queueSelect.value = queueValue;
                if (serviceSelect) serviceSelect.value = serviceTypeValue;
                if (classSelect) classSelect.value = serviceValue;
                
                updateStatus();
                log('‚úì Cen√°rio configurado', 'success');
                
                // Executar valida√ß√µes automaticamente
                setTimeout(() => {
                    runAllValidations();
                }, 200);
                
            } catch (error) {
                logError('Erro ao configurar cen√°rio', error);
            }
        }

        // Inicializar ServiceTypeValidator
        function initializeValidator() {
            try {
                log('üöÄ Inicializando componentes...', 'info');
                
                // Inicializar AlertSystem
                alertSystem = new AlertSystem();
                log('‚úÖ AlertSystem inicializado', 'success');
                
                // Inicializar ConfigManager
                configManager = new ConfigManager();
                log('‚úÖ ConfigManager inicializado', 'success');
                
                // Inicializar QueueValidator
                queueValidator = new QueueValidator(configManager, alertSystem);
                log('‚úÖ QueueValidator inicializado', 'success');
                
                // Inicializar ServiceTypeValidator
                serviceTypeValidator = new ServiceTypeValidator(configManager, alertSystem);
                log('‚úÖ ServiceTypeValidator inicializado', 'success');
                
                log('üéØ Todos os componentes inicializados com sucesso!', 'success');
                
            } catch (error) {
                logError('Erro na inicializa√ß√£o', error);
            }
        }

        // Executar todas as valida√ß√µes
        async function runAllValidations() {
            if (!serviceTypeValidator) {
                log('‚ùå ServiceTypeValidator n√£o inicializado', 'error');
                return;
            }

            try {
                log('üîÑ Executando todas as valida√ß√µes...', 'info');
                
                await serviceTypeValidator.validateAll();
                
                log('‚úÖ Todas as valida√ß√µes executadas', 'success');
                
            } catch (error) {
                logError('Erro durante valida√ß√µes', error);
            }
        }

        // Valida√ß√µes espec√≠ficas
        async function validateTechnicalLocal() {
            if (!serviceTypeValidator) {
                log('‚ùå ServiceTypeValidator n√£o inicializado', 'error');
                return;
            }

            try {
                log('üîß Validando T√©cnico Local...', 'info');
                await serviceTypeValidator.validateLocalTechnician();
                log('‚úÖ Valida√ß√£o de T√©cnico Local conclu√≠da', 'success');
            } catch (error) {
                logError('Erro na valida√ß√£o de T√©cnico Local', error);
            }
        }

        async function validateTechnicalRemote() {
            if (!serviceTypeValidator) {
                log('‚ùå ServiceTypeValidator n√£o inicializado', 'error');
                return;
            }

            try {
                log('üåê Validando T√©cnico Remoto...', 'info');
                await serviceTypeValidator.validateRemoteTechnician();
                log('‚úÖ Valida√ß√£o de T√©cnico Remoto conclu√≠da', 'success');
            } catch (error) {
                logError('Erro na valida√ß√£o de T√©cnico Remoto', error);
            }
        }

        async function validateServiceType() {
            if (!serviceTypeValidator) {
                log('‚ùå ServiceTypeValidator n√£o inicializado', 'error');
                return;
            }

            try {
                log('üìã Validando Tipo de Servi√ßo...', 'info');
                await serviceTypeValidator.validateServiceTypeForQueue();
                log('‚úÖ Valida√ß√£o de Tipo de Servi√ßo conclu√≠da', 'success');
            } catch (error) {
                logError('Erro na valida√ß√£o de Tipo de Servi√ßo', error);
            }
        }

        // Limpar alertas
        function clearAllAlerts() {
            if (alertSystem) {
                alertSystem.clearAll();
                log('üóëÔ∏è Todos os alertas limpos', 'info');
            }
        }

        // Event listeners para os campos
        function setupEventListeners() {
            try {
                document.querySelector('#Dest')?.addEventListener('change', () => {
                    log('üìù Queue alterada', 'info');
                    updateStatus();
                    setTimeout(runAllValidations, 100);
                });
                
                document.querySelector('#DynamicField_PRITipoAtendimento')?.addEventListener('change', () => {
                    log('üìù Tipo de atendimento alterado', 'info');
                    updateStatus();
                    setTimeout(runAllValidations, 100);
                });
                
                document.querySelector('#ServiceID')?.addEventListener('change', () => {
                    log('üìù Classifica√ß√£o alterada', 'info');
                    updateStatus();
                    setTimeout(runAllValidations, 100);
                });
                
            } catch (error) {
                logError('Erro ao configurar event listeners', error);
            }
        }

        // Interceptar erros do console
        window.addEventListener('error', (event) => {
            logError('Erro JavaScript capturado', event.error);
        });

        // Inicializar quando a p√°gina carregar
        window.addEventListener('load', () => {
            try {
                log('üåü Sistema de teste carregado', 'success');
                updateStatus();
                setupEventListeners();
                
                // Inicializar automaticamente
                setTimeout(() => {
                    initializeValidator();
                }, 500);
                
            } catch (error) {
                logError('Erro na inicializa√ß√£o da p√°gina', error);
            }
        });
    </script>
</body>
</html>
