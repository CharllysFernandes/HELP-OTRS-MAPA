<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Help OTRS - Arquitetura Modular</title>
</head>
<body>
    <h1>Teste da ExtensÃ£o Help OTRS</h1>
    
    <div id="test-results">
        <h2>Resultados dos Testes:</h2>
        <ul id="results-list"></ul>
    </div>

    <div id="alert-tests">
        <h2>Teste do Sistema de Alertas:</h2>
        <button onclick="testAlerts()">ğŸš¨ Testar Alertas</button>
        <button onclick="testValidationAlerts()">ğŸ” Testar ValidaÃ§Ã£o de Fila</button>
        <button onclick="testCustomAlerts()">ğŸ“‹ Testar Alertas Personalizados</button>
        <button onclick="testServiceTypeDetection()">ğŸ”§ Testar Tipo de Atendimento</button>
        <button onclick="clearAlerts()">ğŸ§¹ Limpar Alertas</button>
    </div>

    <!-- Simular elementos OTRS para teste -->
    <div id="otrs-simulation" style="display: none;">
        <select id="Dest">
            <option value="1">TI::Desenvolvimento||TÃ©cnico Local</option>
            <option value="2" selected>TI::Suporte||NÃ­vel 1</option>
        </select>
        <input id="Dest_Search" value="TI::Suporte">
        <div class="InputField_Selection">
            <div class="Text">TI::Suporte</div>
        </div>
        
        <!-- Simular campo de tipo de atendimento -->
        <input type="radio" name="ServiceType" value="Remoto" checked> Remoto
        <input type="radio" name="ServiceType" value="Presencial"> Presencial
    </div>

    <!-- Simular estrutura do botÃ£o OTRS -->
    <div style="margin-top: 30px; padding: 20px; border: 1px solid #ccc;">
        <h3>SimulaÃ§Ã£o da Interface OTRS:</h3>
        <p>Este Ã© o conteÃºdo do formulÃ¡rio...</p>
        
        <div class="Field SpacingTop">
            <button class="Primary CallForAction" id="submitRichText" accesskey="g" title="Criar (g)" type="submit" value="Criar">
                <span><i class="fa fa-check-square-o"></i> Criar</span>
            </button>
        </div>
    </div>

    <!-- Carregar mÃ³dulos na ordem correta -->
    <script src="src/core/ConfigManager.js"></script>
    <script src="src/core/DebugHelper.js"></script>
    <script src="src/core/AlertSystem.js"></script>
    <script src="src/core/FormDataReuser.js"></script>
    <script src="src/modules/QueueValidator.js"></script>
    <script src="src/modules/ServiceTypeValidator.js"></script>
    <script src="src/main.js"></script>

    <script>
        // Teste bÃ¡sico para verificar se os mÃ³dulos foram carregados
        function runTests() {
            const results = document.getElementById('results-list');
            const tests = [
                { name: 'HelpOTRS namespace', test: () => !!window.HelpOTRS },
                { name: 'ConfigManager', test: () => !!window.HelpOTRS.ConfigManager },
                { name: 'DebugHelper', test: () => !!window.HelpOTRS.DebugHelper },
                { name: 'AlertSystem', test: () => !!window.HelpOTRS.AlertSystem },
                { name: 'FormDataReuser', test: () => !!window.HelpOTRS.FormDataReuser },
                { name: 'QueueValidator', test: () => !!window.HelpOTRS.QueueValidator },
                { name: 'ServiceTypeValidator', test: () => !!window.HelpOTRS.ServiceTypeValidator },
                { name: 'HelpOtrsApp', test: () => !!window.HelpOtrsApp }
            ];

            tests.forEach(test => {
                const li = document.createElement('li');
                const result = test.test();
                li.textContent = `${test.name}: ${result ? 'âœ… OK' : 'âŒ FALHOU'}`;
                li.style.color = result ? 'green' : 'red';
                results.appendChild(li);
            });

            console.log('Help OTRS: Testes de mÃ³dulos executados');
        }

        // Executar testes apÃ³s carregamento
        window.addEventListener('load', () => {
            setTimeout(runTests, 1000);
        });

        // Teste do sistema de alertas
        function testAlerts() {
            if (window.HelpOTRS && window.HelpOTRS.AlertSystem) {
                const alertSystem = new window.HelpOTRS.AlertSystem();
                
                alertSystem.showError('test-error', 'âŒ Erro de Teste', 'Este Ã© um alerta de erro para demonstraÃ§Ã£o');
                
                setTimeout(() => {
                    alertSystem.showWarning('test-warning', 'âš ï¸ Aviso de Teste', 'Este Ã© um alerta de aviso para demonstraÃ§Ã£o');
                }, 1000);
                
                setTimeout(() => {
                    alertSystem.showInfo('test-info', 'â„¹ï¸ Info de Teste', 'Este Ã© um alerta informativo para demonstraÃ§Ã£o');
                }, 2000);
                
                setTimeout(() => {
                    alertSystem.showSuccess('test-success', 'âœ… Sucesso de Teste', 'Este Ã© um alerta de sucesso para demonstraÃ§Ã£o');
                }, 3000);

                setTimeout(() => {
                    alertSystem.showQueueWarning('test-queue', 'Fila incompatÃ­vel com perfil de usuÃ¡rio', 'TI::Desenvolvimento', 'TÃ©cnico Local');
                }, 4000);
            }
        }

        function testValidationAlerts() {
            if (window.HelpOTRS) {
                try {
                    // Simular configuraÃ§Ã£o
                    const configManager = new window.HelpOTRS.ConfigManager();
                    const alertSystem = new window.HelpOTRS.AlertSystem();
                    
                    // Teste 1: Perfis COMPATÃVEIS - NÃ­vel 1 (perfil) vs TÃ©cnico Remoto (fila)
                    console.log('=== TESTE 1: PERFIS COMPATÃVEIS ===');
                    configManager.currentOtrsSystem = {
                        name: 'Sistema Teste',
                        userProfile: 'NÃ­vel 1'  // UsuÃ¡rio Ã© NÃ­vel 1
                    };
                    
                    // Simular fila "TÃ©cnico Remoto" (que Ã© equivalente a NÃ­vel 1)
                    const queueValidator = new window.HelpOTRS.QueueValidator(configManager, alertSystem);
                    
                    // Override da funÃ§Ã£o para simular fila especÃ­fica
                    queueValidator.getCurrentQueue = () => 'TÃ©cnico Remoto';
                    queueValidator.getCurrentQueueLevel = () => configManager.normalizeUserLevel('TÃ©cnico Remoto');
                    
                    console.log('Fila simulada:', queueValidator.getCurrentQueue());
                    console.log('NÃ­vel da fila:', queueValidator.getCurrentQueueLevel());
                    console.log('Perfil do usuÃ¡rio:', configManager.getUserProfile());
                    console.log('SÃ£o compatÃ­veis?', configManager.compareUserLevels(queueValidator.getCurrentQueueLevel(), configManager.getUserProfile()));
                    
                    // Executar validaÃ§Ã£o
                    queueValidator.validateCurrentQueue();
                    
                    // Teste 2: Perfis INCOMPATÃVEIS - TÃ©cnico Local vs TÃ©cnico Remoto
                    setTimeout(() => {
                        console.log('=== TESTE 2: PERFIS INCOMPATÃVEIS ===');
                        
                        // Limpar alertas anteriores
                        alertSystem.clearAll();
                        
                        configManager.currentOtrsSystem = {
                            name: 'Sistema Teste',
                            userProfile: 'TÃ©cnico Local'  // UsuÃ¡rio Ã© TÃ©cnico Local (NÃ­vel 2)
                        };
                        
                        const queueValidator2 = new window.HelpOTRS.QueueValidator(configManager, alertSystem);
                        queueValidator2.getCurrentQueue = () => 'TÃ©cnico Remoto';
                        queueValidator2.getCurrentQueueLevel = () => configManager.normalizeUserLevel('TÃ©cnico Remoto');
                        
                        console.log('Fila simulada:', queueValidator2.getCurrentQueue());
                        console.log('NÃ­vel da fila:', queueValidator2.getCurrentQueueLevel());
                        console.log('Perfil do usuÃ¡rio:', configManager.getUserProfile());
                        console.log('SÃ£o compatÃ­veis?', configManager.compareUserLevels(queueValidator2.getCurrentQueueLevel(), configManager.getUserProfile()));
                        
                        queueValidator2.validateCurrentQueue();
                    }, 3000);
                    
                    console.log('âœ… Teste executado sem erros');
                } catch (error) {
                    console.error('âŒ Erro no teste:', error);
                    alert('Erro no teste: ' + error.message);
                }
            } else {
                console.error('âŒ HelpOTRS nÃ£o estÃ¡ disponÃ­vel');
                alert('HelpOTRS nÃ£o carregado corretamente');
            }
        }

        function testCustomAlerts() {
            if (window.HelpOTRS && window.HelpOTRS.AlertSystem) {
                const alertSystem = new window.HelpOTRS.AlertSystem();
                
                // Teste 1: Alert de perfil e fila
                alertSystem.showUserProfileAlert('TÃ©cnico Local', 'TI::Desenvolvimento');
                
                // Teste 2: Alert de tipo de atendimento (apÃ³s 2 segundos)
                setTimeout(() => {
                    alertSystem.showServiceTypeQueueAlert('TI::Suporte', 'Presencial', 'Remoto');
                }, 2000);
            }
        }

        function testServiceTypeDetection() {
            if (window.HelpOTRS && window.HelpOTRS.AlertSystem) {
                const alertSystem = new window.HelpOTRS.AlertSystem();
                
                console.log('=== TESTE DE DETECÃ‡ÃƒO DE TIPO DE ATENDIMENTO ===');
                
                // Testar detecÃ§Ã£o atual
                const currentServiceType = alertSystem.detectCurrentServiceType();
                console.log('Tipo de atendimento detectado:', currentServiceType);
                
                if (currentServiceType) {
                    alert(`Tipo de atendimento detectado: ${currentServiceType}`);
                } else {
                    alert('Nenhum tipo de atendimento detectado. Verifique se hÃ¡ campos de tipo de atendimento na pÃ¡gina.');
                }
                
                // Testar os seletores individualmente
                const selectors = [
                    'input[name*="ServiceType"]:checked',
                    'select[name*="ServiceType"] option:selected',
                    'input[name*="TipoAtendimento"]:checked',
                    'select[name*="TipoAtendimento"] option:selected',
                    'input[id*="DynamicField"][id*="Tipo"]:checked',
                    'select[id*="DynamicField"][id*="Tipo"] option:selected'
                ];
                
                selectors.forEach((selector, index) => {
                    const element = document.querySelector(selector);
                    console.log(`Seletor ${index + 1} (${selector}):`, element ? 'Encontrado' : 'NÃ£o encontrado');
                    if (element) {
                        console.log('  Valor:', element.value);
                        console.log('  Texto:', element.textContent);
                    }
                });
            }
        }

        function clearAlerts() {
            const alerts = document.querySelectorAll('.help-otrs-alert');
            alerts.forEach(alert => alert.remove());
        }
    </script>
</body>
</html>
