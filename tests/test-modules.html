<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Help OTRS - Arquitetura Modular</title>
</head>
<body>
    <h1>Teste da Extens√£o Help OTRS</h1>
    
    <div id="test-results">
        <h2>Resultados dos Testes:</h2>
        <ul id="results-list"></ul>
    </div>

    <div id="alert-tests">
        <h2>Teste do Sistema de Alertas:</h2>
        <button onclick="testAlerts()">üö® Testar Alertas</button>
        <button onclick="testValidationAlerts()">üîç Testar Valida√ß√£o de Fila</button>
        <button onclick="testCustomAlerts()">üìã Testar Alertas Personalizados</button>
        <button onclick="testServiceTypeDetection()">üîß Testar Tipo de Atendimento</button>
        <button onclick="clearAlerts()">üßπ Limpar Alertas</button>
    </div>

    <!-- Simular elementos OTRS para teste -->
    <div id="otrs-simulation" style="display: none;">
        <select id="Dest">
            <option value="1">TI::Desenvolvimento||T√©cnico Local</option>
            <option value="2" selected>TI::Suporte||N√≠vel 1</option>
        </select>
        <input id="Dest_Search" value="TI::Suporte">
        <div class="InputField_Selection">
            <div class="Text">TI::Suporte</div>
        </div>
        
        <!-- Simular campo de tipo de atendimento -->
        <input type="radio" name="ServiceType" value="Remoto" checked> Remoto
        <input type="radio" name="ServiceType" value="Presencial"> Presencial
    </div>

    <!-- Simular estrutura do bot√£o OTRS -->
    <div style="margin-top: 30px; padding: 20px; border: 1px solid #ccc;">
        <h3>Simula√ß√£o da Interface OTRS:</h3>
        <p>Este √© o conte√∫do do formul√°rio...</p>
        
        <div class="Field SpacingTop">
            <button class="Primary CallForAction" id="submitRichText" accesskey="g" title="Criar (g)" type="submit" value="Criar">
                <span><i class="fa fa-check-square-o"></i> Criar</span>
            </button>
        </div>
    </div>

    <!-- Carregar m√≥dulos na ordem correta -->
    <script src="src/core/ConfigManager.js"></script>
    <script src="src/core/DebugHelper.js"></script>
    <script src="src/core/AlertSystem.js"></script>
    <script src="src/core/FormDataReuser.js"></script>
    <script src="src/modules/QueueValidator.js"></script>
    <script src="src/modules/ServiceTypeValidator.js"></script>
    <script src="src/main.js"></script>

    <script>
        // Teste b√°sico para verificar se os m√≥dulos foram carregados
        function runTests() {
            const results = document.getElementById('results-list');
            const tests = [
                { name: 'HelpOTRS namespace', test: () => !!window.HelpOTRS },
                { name: 'ConfigManager', test: () => !!window.HelpOTRS.ConfigManager },
                { name: 'DebugHelper', test: () => !!window.HelpOTRS.DebugHelper },
                { name: 'AlertSystem', test: () => !!window.HelpOTRS.AlertSystem },
                { name: 'FormDataReuser', test: () => !!window.HelpOTRS.FormDataReuser },
                { name: 'QueueValidator', test: () => !!window.HelpOTRS.QueueValidator },
                { name: 'ServiceTypeValidator', test: () => !!window.HelpOTRS.ServiceTypeValidator },
                { name: 'HelpOtrsApp', test: () => !!window.HelpOtrsApp }
            ];

            tests.forEach(test => {
                const li = document.createElement('li');
                const result = test.test();
                li.textContent = `${test.name}: ${result ? '‚úÖ OK' : '‚ùå FALHOU'}`;
                li.style.color = result ? 'green' : 'red';
                results.appendChild(li);
            });

            console.log('Help OTRS: Testes de m√≥dulos executados');
        }

        // Executar testes ap√≥s carregamento
        window.addEventListener('load', () => {
            setTimeout(runTests, 1000);
        });

        // Teste do sistema de alertas
        function testAlerts() {
            if (window.HelpOTRS && window.HelpOTRS.AlertSystem) {
                const alertSystem = new window.HelpOTRS.AlertSystem();
                
                alertSystem.showError('test-error', '‚ùå Erro de Teste', 'Este √© um alerta de erro para demonstra√ß√£o');
                
                setTimeout(() => {
                    alertSystem.showWarning('test-warning', '‚ö†Ô∏è Aviso de Teste', 'Este √© um alerta de aviso para demonstra√ß√£o');
                }, 1000);
                
                setTimeout(() => {
                    alertSystem.showInfo('test-info', '‚ÑπÔ∏è Info de Teste', 'Este √© um alerta informativo para demonstra√ß√£o');
                }, 2000);
                
                setTimeout(() => {
                    alertSystem.showSuccess('test-success', '‚úÖ Sucesso de Teste', 'Este √© um alerta de sucesso para demonstra√ß√£o');
                }, 3000);

                setTimeout(() => {
                    alertSystem.showQueueWarning('test-queue', 'Fila incompat√≠vel com perfil de usu√°rio', 'TI::Desenvolvimento', 'T√©cnico Local');
                }, 4000);
            }
        }

        function testValidationAlerts() {
            if (window.HelpOTRS) {
                try {
                    // Simular configura√ß√£o
                    const configManager = new window.HelpOTRS.ConfigManager();
                    const alertSystem = new window.HelpOTRS.AlertSystem();
                    
                    // Teste 1: Perfis COMPAT√çVEIS - N√≠vel 1 (perfil) vs T√©cnico Remoto (fila)
                    console.log('=== TESTE 1: PERFIS COMPAT√çVEIS ===');
                    configManager.currentOtrsSystem = {
                        name: 'Sistema Teste',
                        userProfile: 'N√≠vel 1'  // Usu√°rio √© N√≠vel 1
                    };
                    
                    // Simular fila "T√©cnico Remoto" (que √© equivalente a N√≠vel 1)
                    const queueValidator = new window.HelpOTRS.QueueValidator(configManager, alertSystem);
                    
                    // Override da fun√ß√£o para simular fila espec√≠fica
                    queueValidator.getCurrentQueue = () => 'T√©cnico Remoto';
                    queueValidator.getCurrentQueueLevel = () => configManager.normalizeUserLevel('T√©cnico Remoto');
                    
                    console.log('Fila simulada:', queueValidator.getCurrentQueue());
                    console.log('N√≠vel da fila:', queueValidator.getCurrentQueueLevel());
                    console.log('Perfil do usu√°rio:', configManager.getUserProfile());
                    console.log('S√£o compat√≠veis?', configManager.compareUserLevels(queueValidator.getCurrentQueueLevel(), configManager.getUserProfile()));
                    
                    // Executar valida√ß√£o
                    queueValidator.validateCurrentQueue();
                    
                    // Teste 2: Perfis INCOMPAT√çVEIS - T√©cnico Local vs T√©cnico Remoto
                    setTimeout(() => {
                        console.log('=== TESTE 2: PERFIS INCOMPAT√çVEIS ===');
                        
                        // Limpar alertas anteriores
                        alertSystem.clearAll();
                        
                        configManager.currentOtrsSystem = {
                            name: 'Sistema Teste',
                            userProfile: 'T√©cnico Local'  // Usu√°rio √© T√©cnico Local (N√≠vel 2)
                        };
                        
                        const queueValidator2 = new window.HelpOTRS.QueueValidator(configManager, alertSystem);
                        queueValidator2.getCurrentQueue = () => 'T√©cnico Remoto';
                        queueValidator2.getCurrentQueueLevel = () => configManager.normalizeUserLevel('T√©cnico Remoto');
                        
                        console.log('Fila simulada:', queueValidator2.getCurrentQueue());
                        console.log('N√≠vel da fila:', queueValidator2.getCurrentQueueLevel());
                        console.log('Perfil do usu√°rio:', configManager.getUserProfile());
                        console.log('S√£o compat√≠veis?', configManager.compareUserLevels(queueValidator2.getCurrentQueueLevel(), configManager.getUserProfile()));
                        
                        queueValidator2.validateCurrentQueue();
                    }, 3000);
                    
                    console.log('‚úÖ Teste executado sem erros');
                } catch (error) {
                    console.error('‚ùå Erro no teste:', error);
                    alert('Erro no teste: ' + error.message);
                }
            } else {
                console.error('‚ùå HelpOTRS n√£o est√° dispon√≠vel');
                alert('HelpOTRS n√£o carregado corretamente');
            }
        }

        function testCustomAlerts() {
            if (window.HelpOTRS && window.HelpOTRS.AlertSystem) {
                const alertSystem = new window.HelpOTRS.AlertSystem();
                
                // Teste 1: Alert de perfil e fila
                alertSystem.showUserProfileAlert('T√©cnico Local', 'TI::Desenvolvimento');
                
                // Teste 2: Alert de tipo de atendimento (ap√≥s 2 segundos)
                setTimeout(() => {
                    alertSystem.showServiceTypeQueueAlert('TI::Suporte', 'Presencial', 'Remoto');
                }, 2000);
            }
        }

        function testServiceTypeDetection() {
            if (window.HelpOTRS && window.HelpOTRS.AlertSystem) {
                const alertSystem = new window.HelpOTRS.AlertSystem();
                
                console.log('=== TESTE DE DETEC√á√ÉO DE TIPO DE ATENDIMENTO ===');
                
                // Testar detec√ß√£o atual
                const currentServiceType = alertSystem.detectCurrentServiceType();
                console.log('Tipo de atendimento detectado:', currentServiceType);
                
                if (currentServiceType) {
                    alert(`Tipo de atendimento detectado: ${currentServiceType}`);
                } else {
                    alert('Nenhum tipo de atendimento detectado. Verifique se h√° campos de tipo de atendimento na p√°gina.');
                }
                
                // Testar os seletores individualmente
                const selectors = [
                    'input[name*="ServiceType"]:checked',
                    'select[name*="ServiceType"] option:selected',
                    'input[name*="TipoAtendimento"]:checked',
                    'select[name*="TipoAtendimento"] option:selected',
                    'input[id*="DynamicField"][id*="Tipo"]:checked',
                    'select[id*="DynamicField"][id*="Tipo"] option:selected'
                ];
                
                selectors.forEach((selector, index) => {
                    const element = document.querySelector(selector);
                    console.log(`Seletor ${index + 1} (${selector}):`, element ? 'Encontrado' : 'N√£o encontrado');
                    if (element) {
                        console.log('  Valor:', element.value);
                        console.log('  Texto:', element.textContent);
                    }
                });
            }
        }

        function clearAlerts() {
            const alerts = document.querySelectorAll('.help-otrs-alert');
            alerts.forEach(alert => alert.remove());
        }
    </script>
</body>
</html>
