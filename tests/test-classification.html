<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - ClassificationValidator - Help OTRS</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .form-field {
            margin: 15px 0;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        select, input {
            width: 100%;
            max-width: 300px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .otrs-popup {
            background: #f8f9fa;
            border: 2px solid #007bff;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .otrs-form {
            background: white;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        /* Simula√ß√£o de estilos OTRS */
        .Popup.RealPopup {
            background: white;
        }
        .WidgetSimple .Content {
            background: #f9f9f9;
            padding: 15px;
        }
        .Field {
            margin: 10px 0;
        }
        .InputField_Container {
            position: relative;
        }
        .InputField_Selection {
            background: #e9ecef;
            padding: 5px;
            border: 1px solid #ced4da;
            margin-bottom: 5px;
            border-radius: 3px;
        }
        .Mandatory .Marker {
            color: red;
            font-weight: bold;
        }
        .Footer {
            margin-top: 20px;
            padding: 15px;
            border-top: 1px solid #ddd;
            text-align: center;
        }
        .Footer button {
            margin: 0 10px;
        }
    </style>
</head>
<body class="Popup RealPopup">
    <div class="container">
        <h1>üß™ Teste - ClassificationValidator</h1>
        
        <div class="info">
            <strong>üìã Simula√ß√£o da Janela de Classifica√ß√£o OTRS</strong><br>
            Esta p√°gina simula os elementos principais de uma janela de classifica√ß√£o do OTRS para testar o ClassificationValidator.
        </div>

        <!-- Simula√ß√£o da janela de classifica√ß√£o -->
        <div class="otrs-popup">
            <h2>Adicionar nota para Chamado#55234547 ‚Äî Manuten√ß√£o Impressora</h2>
            
            <form name="compose" id="Compose" class="otrs-form">
                <input type="hidden" name="Action" value="AgentTicketNote">
                <input type="hidden" name="TicketID" value="234677">
                
                <div class="WidgetSimple">
                    <div class="Header">
                        <h3>Configura√ß√µes de Chamado</h3>
                    </div>
                    <div class="Content">
                        
                        <!-- Campo Tipo -->
                        <div class="Field">
                            <label class="Mandatory" for="TypeID">
                                <span class="Marker">*</span>Tipo:
                            </label>
                            <div class="InputField_Container">
                                <div class="InputField_Selection">
                                    <div class="Text">Requisi√ß√£o</div>
                                </div>
                                <select id="TypeID" name="TypeID" style="display: none;">
                                    <option value="">-</option>
                                    <option value="8">Incidente</option>
                                    <option value="15" selected>Requisi√ß√£o</option>
                                </select>
                            </div>
                        </div>

                        <!-- Campo Servi√ßo -->
                        <div class="Field">
                            <label class="Mandatory" for="ServiceID">
                                <span class="Marker">*</span>Servi√ßo:
                            </label>
                            <div class="InputField_Container">
                                <div class="InputField_Selection">
                                    <div class="Text">Instalar, Configurar ou Mapear Impressora ou Scanner</div>
                                </div>
                                <select id="ServiceID" name="ServiceID" style="display: none;">
                                    <option value="">-</option>
                                    <option value="2472" selected>Instalar, Configurar ou Mapear Impressora ou Scanner</option>
                                </select>
                            </div>
                        </div>

                        <!-- Campo Localidade -->
                        <div class="Field">
                            <label class="Mandatory" for="DynamicField_localidade">
                                <span class="Marker">*</span>Localidade:
                            </label>
                            <div class="InputField_Container">
                                <div class="InputField_Selection">
                                    <div class="Text">DF - SEDE - Mapa</div>
                                </div>
                                <select id="DynamicField_localidade" name="DynamicField_localidade" style="display: none;">
                                    <option value="">-</option>
                                    <option value="DF - SEDE - Mapa" selected>DF - SEDE - Mapa</option>
                                    <option value="SP - SFA - S√£o Paulo">SP - SFA - S√£o Paulo</option>
                                    <option value="RJ - SFA - Rio de Janeiro">RJ - SFA - Rio de Janeiro</option>
                                </select>
                            </div>
                        </div>

                        <!-- Campo Tipo de Atendimento (PRINCIPAL PARA O TESTE) -->
                        <div class="Field">
                            <label class="Mandatory" for="DynamicField_PRITipoAtendimento">
                                <span class="Marker">*</span>Tipo Atendimento:
                            </label>
                            <div class="InputField_Container">
                                <div class="InputField_Selection">
                                    <div class="Text">-</div>
                                </div>
                                <select id="DynamicField_PRITipoAtendimento" name="DynamicField_PRITipoAtendimento" style="display: block !important;">
                                    <option value="-" selected>-</option>
                                    <option value="P">Presencial</option>
                                    <option value="R">Remoto</option>
                                </select>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Footer com bot√µes -->
                <div class="Footer">
                    <button type="button" id="submitRichText" class="Primary CallForAction">
                        <span>‚úÖ Enviar</span>
                    </button>
                    <button type="button">
                        <span>üìù Salvar como rascunho</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Controles de Teste -->
        <div class="test-section">
            <h3>üîß Controles de Teste</h3>
            
            <div class="form-field">
                <label for="testServiceType">Simular Sele√ß√£o de Tipo de Atendimento:</label>
                <select id="testServiceType">
                    <option value="-">- (N√£o Selecionado)</option>
                    <option value="R">R (Remoto)</option>
                    <option value="P">P (Presencial)</option>
                </select>
            </div>

            <div class="form-field">
                <button onclick="simulateServiceTypeChange()">üîÑ Aplicar Mudan√ßa</button>
                <button onclick="clearAlerts()">üóëÔ∏è Limpar Alertas</button>
                <button onclick="showStats()">üìä Ver Estat√≠sticas</button>
                <button onclick="testDetection()">üîç Testar Detec√ß√£o</button>
            </div>
        </div>

        <!-- Informa√ß√µes de Debug -->
        <div class="test-section">
            <h3>üêõ Debug Info</h3>
            <div id="debugInfo">
                <p><strong>Estado:</strong> <span id="debugStatus">Aguardando inicializa√ß√£o...</span></p>
                <p><strong>P√°gina Detectada:</strong> <span id="debugPageType">-</span></p>
                <p><strong>Campo Encontrado:</strong> <span id="debugFieldFound">-</span></p>
                <p><strong>Valor Atual:</strong> <span id="debugCurrentValue">-</span></p>
            </div>
        </div>

        <!-- √Årea para Logs -->
        <div class="test-section">
            <h3>üìù Logs de Teste</h3>
            <div id="testLogs" style="background: #f8f9fa; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto;">
                <p>Aguardando inicializa√ß√£o dos m√≥dulos...</p>
            </div>
            <button onclick="clearLogs()" style="margin-top: 10px;">üóëÔ∏è Limpar Logs</button>
        </div>
    </div>

    <!-- Scripts dos m√≥dulos Help OTRS -->
    <script src="../src/core/AlertSystem.js"></script>
    <script src="../src/modules/ClassificationValidator.js"></script>

    <!-- Script de teste -->
    <script>
        // Vari√°veis globais para teste
        let alertSystem = null;
        let classificationValidator = null;
        
        // Log personalizado para o teste
        function testLog(message, type = 'info') {
            const logsDiv = document.getElementById('testLogs');
            const timestamp = new Date().toLocaleTimeString();
            const typeIcon = {
                'info': '‚ÑπÔ∏è',
                'success': '‚úÖ',
                'warning': '‚ö†Ô∏è',
                'error': '‚ùå',
                'debug': 'üêõ'
            }[type] || '‚ÑπÔ∏è';
            
            logsDiv.innerHTML += `<p>[${timestamp}] ${typeIcon} ${message}</p>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        // Interceptar console.log para capturar logs dos m√≥dulos
        const originalLog = console.log;
        console.log = function(...args) {
            const message = args.join(' ');
            if (message.includes('Help OTRS')) {
                testLog(message, 'debug');
            }
            originalLog.apply(console, args);
        };

        // Interceptar console.error
        const originalError = console.error;
        console.error = function(...args) {
            const message = args.join(' ');
            if (message.includes('Help OTRS')) {
                testLog(message, 'error');
            }
            originalError.apply(console, args);
        };

        // Fun√ß√£o para inicializar teste
        async function initializeTest() {
            testLog('üöÄ Iniciando teste do ClassificationValidator...', 'info');
            
            try {
                // Aguardar m√≥dulos estarem dispon√≠veis
                if (!window.HelpOTRS || !window.HelpOTRS.AlertSystem || !window.HelpOTRS.ClassificationValidator) {
                    testLog('‚è≥ Aguardando m√≥dulos...', 'warning');
                    setTimeout(initializeTest, 100);
                    return;
                }
                
                // Inicializar AlertSystem
                alertSystem = new window.HelpOTRS.AlertSystem();
                testLog('‚úÖ AlertSystem inicializado', 'success');
                
                // Inicializar ClassificationValidator
                classificationValidator = new window.HelpOTRS.ClassificationValidator();
                classificationValidator.init(alertSystem);
                testLog('‚úÖ ClassificationValidator inicializado', 'success');
                
                // Atualizar interface de debug
                updateDebugInfo();
                
                testLog('üéâ Teste inicializado com sucesso!', 'success');
                
            } catch (error) {
                testLog(`‚ùå Erro na inicializa√ß√£o: ${error.message}`, 'error');
                console.error('Erro na inicializa√ß√£o do teste:', error);
            }
        }

        // Atualizar informa√ß√µes de debug
        function updateDebugInfo() {
            try {
                document.getElementById('debugStatus').textContent = classificationValidator ? 'Inicializado' : 'N√£o inicializado';
                
                if (classificationValidator) {
                    const stats = classificationValidator.getStats();
                    document.getElementById('debugPageType').textContent = stats.currentPageType?.isClassification ? 'Janela de Classifica√ß√£o' : 'P√°gina Normal';
                    
                    const field = document.querySelector('#DynamicField_PRITipoAtendimento');
                    document.getElementById('debugFieldFound').textContent = field ? `${field.tagName}#${field.id}` : 'N√£o encontrado';
                    document.getElementById('debugCurrentValue').textContent = field ? (field.value || '-') : '-';
                }
                
            } catch (error) {
                testLog(`‚ùå Erro ao atualizar debug: ${error.message}`, 'error');
            }
        }

        // Simular mudan√ßa no tipo de atendimento
        function simulateServiceTypeChange() {
            try {
                const testSelect = document.getElementById('testServiceType');
                const targetField = document.querySelector('#DynamicField_PRITipoAtendimento');
                
                if (!targetField) {
                    testLog('‚ùå Campo de tipo de atendimento n√£o encontrado', 'error');
                    return;
                }
                
                const newValue = testSelect.value;
                targetField.value = newValue;
                
                // Disparar evento de mudan√ßa
                const changeEvent = new Event('change', { bubbles: true });
                targetField.dispatchEvent(changeEvent);
                
                testLog(`üîÑ Valor alterado para: ${newValue}`, 'info');
                updateDebugInfo();
                
            } catch (error) {
                testLog(`‚ùå Erro ao simular mudan√ßa: ${error.message}`, 'error');
            }
        }

        // Limpar alertas
        function clearAlerts() {
            try {
                if (alertSystem) {
                    alertSystem.clearAll();
                    testLog('üóëÔ∏è Alertas limpos', 'info');
                } else {
                    testLog('‚ö†Ô∏è AlertSystem n√£o inicializado', 'warning');
                }
            } catch (error) {
                testLog(`‚ùå Erro ao limpar alertas: ${error.message}`, 'error');
            }
        }

        // Mostrar estat√≠sticas
        function showStats() {
            try {
                if (classificationValidator) {
                    const stats = classificationValidator.getStats();
                    testLog(`üìä Stats: ${JSON.stringify(stats, null, 2)}`, 'info');
                }
                
                if (alertSystem) {
                    const alertStats = alertSystem.getStats();
                    testLog(`üìä Alert Stats: ${JSON.stringify(alertStats, null, 2)}`, 'info');
                }
                
            } catch (error) {
                testLog(`‚ùå Erro ao obter estat√≠sticas: ${error.message}`, 'error');
            }
        }

        // Testar detec√ß√£o
        function testDetection() {
            try {
                if (classificationValidator) {
                    testLog('üîç Testando detec√ß√£o de p√°gina...', 'info');
                    const isClassification = classificationValidator.isClassificationWindow();
                    testLog(`üéØ Resultado: ${isClassification ? 'Janela de Classifica√ß√£o detectada' : 'N√£o √© janela de classifica√ß√£o'}`, isClassification ? 'success' : 'warning');
                    
                    // Testar detec√ß√£o de campo
                    const field = classificationValidator.findServiceTypeField();
                    testLog(`üîç Campo detectado: ${field ? field.id || field.name : 'Nenhum'}`, field ? 'success' : 'warning');
                } else {
                    testLog('‚ö†Ô∏è ClassificationValidator n√£o inicializado', 'warning');
                }
            } catch (error) {
                testLog(`‚ùå Erro no teste de detec√ß√£o: ${error.message}`, 'error');
            }
        }

        // Limpar logs
        function clearLogs() {
            document.getElementById('testLogs').innerHTML = '<p>Logs limpos...</p>';
        }

        // Inicializar quando a p√°gina carregar
        window.addEventListener('load', () => {
            testLog('üìÑ P√°gina carregada, iniciando teste...', 'info');
            setTimeout(initializeTest, 500);
        });

        // Atualizar debug a cada 2 segundos
        setInterval(updateDebugInfo, 2000);
    </script>
</body>
</html>
