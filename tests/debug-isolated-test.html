<!DOCTYPE html>
<html>
<head>
    <title>üéØ Teste Isolado: T√©cnico Remoto + Presencial</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { padding: 10px; margin: 5px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; background: #007cba; color: white; border: none; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>üéØ Teste Isolado: T√©cnico Remoto + Presencial</h1>
    
    <div>
        <select id="Dest">
            <option value="T√©cnico Remoto">T√©cnico Remoto</option>
        </select>
        
        <select id="DynamicField_PRITipoAtendimento">
            <option value="P">Presencial</option>
        </select>
    </div>
    
    <button onclick="runIsolatedTest()">üß™ Executar Teste Isolado</button>
    <button onclick="runStepByStep()">üìã Passo a Passo</button>
    <button onclick="clearCache()">üóëÔ∏è Limpar Cache</button>
    
    <div id="output"></div>
    
    <script src="src/core/AlertSystem.js"></script>
    <script>
        const output = document.getElementById('output');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = message;
            output.appendChild(div);
        }
        
        function clearResults() {
            output.innerHTML = '';
        }
        
        function clearCache() {
            if (window.alertSystem && window.alertSystem.selectorCache) {
                window.alertSystem.selectorCache.clear();
                log('üóëÔ∏è Cache limpo', 'success');
            }
        }
        
        function runIsolatedTest() {
            clearResults();
            log('<strong>üß™ TESTE ISOLADO: T√©cnico Remoto + Presencial</strong>', 'info');
            
            try {
                // Garantir que os valores est√£o configurados
                document.querySelector('#Dest').value = 'T√©cnico Remoto';
                document.querySelector('#DynamicField_PRITipoAtendimento').value = 'P';
                
                const alertSystem = new AlertSystem();
                window.alertSystem = alertSystem; // Para debug
                
                // Mock objects
                const mockConfigManager = { getUserProfile: () => 'Test User' };
                const mockQueueValidator = { 
                    getCurrentQueue: () => document.querySelector('#Dest').value 
                };
                
                log('‚úÖ AlertSystem criado', 'success');
                log('‚úÖ Mocks configurados', 'success');
                
                // Teste 1: Verificar valores dos campos
                const queueValue = document.querySelector('#Dest').value;
                const serviceValue = document.querySelector('#DynamicField_PRITipoAtendimento').value;
                
                log(`üìä Queue Value: "${queueValue}"`, 'info');
                log(`üìä Service Value: "${serviceValue}"`, 'info');
                
                // Teste 2: getExpectedServiceTypeForQueue
                const expectedType = alertSystem.getExpectedServiceTypeForQueue(queueValue);
                log(`üéØ Tipo esperado: "${expectedType}"`, expectedType ? 'success' : 'error');
                
                // Teste 3: detectCurrentServiceType
                const detectedType = alertSystem.detectCurrentServiceType();
                log(`üîç Tipo detectado: "${detectedType}"`, detectedType ? 'success' : 'error');
                
                // Teste 4: Verificar inconsist√™ncia
                const hasInconsistency = detectedType && expectedType && detectedType !== expectedType;
                log(`‚öñÔ∏è H√° inconsist√™ncia? ${hasInconsistency}`, hasInconsistency ? 'warning' : 'info');
                
                if (hasInconsistency) {
                    log(`üö® INCONSIST√äNCIA DETECTADA!`, 'warning');
                    log(`  Atual: "${detectedType}" vs Esperado: "${expectedType}"`, 'warning');
                } else {
                    if (detectedType === expectedType) {
                        log(`‚ÑπÔ∏è Tipos s√£o iguais: "${detectedType}"`, 'info');
                    } else {
                        log(`‚ùå Um dos tipos √© null/undefined`, 'error');
                    }
                }
                
                // Teste 5: Executar valida√ß√£o completa
                log('<br><strong>üîÑ Executando validateAndShowAlerts...</strong>', 'info');
                alertSystem.validateAndShowAlerts(mockConfigManager, mockQueueValidator);
                log('‚úÖ validateAndShowAlerts executado', 'success');
                
            } catch (error) {
                log(`‚ùå ERRO: ${error.message}`, 'error');
                console.error('Erro detalhado:', error);
            }
        }
        
        function runStepByStep() {
            clearResults();
            log('<strong>üìã AN√ÅLISE PASSO A PASSO</strong>', 'info');
            
            try {
                const alertSystem = new AlertSystem();
                
                // PASSO 1: An√°lise da fun√ß√£o getExpectedServiceTypeForQueue
                log('<br><strong>PASSO 1: getExpectedServiceTypeForQueue</strong>', 'info');
                const queue = 'T√©cnico Remoto';
                const queueLower = queue.toLowerCase().trim();
                log(`Queue original: "${queue}"`, 'info');
                log(`Queue normalizada: "${queueLower}"`, 'info');
                
                // Testar cada regra individualmente
                const rules = [
                    { name: 'cont√©m "t√©cnico local"', test: queueLower.includes('t√©cnico local'), expected: 'Presencial' },
                    { name: 'cont√©m "tecnico local"', test: queueLower.includes('tecnico local'), expected: 'Presencial' },
                    { name: 'cont√©m "presencial"', test: queueLower.includes('presencial'), expected: 'Presencial' },
                    { name: 'cont√©m "local"', test: queueLower.includes('local'), expected: 'Presencial' },
                    { name: 'cont√©m "remoto"', test: queueLower.includes('remoto'), expected: 'Remoto' },
                    { name: 'cont√©m "n√≠vel 1"', test: queueLower.includes('n√≠vel 1'), expected: 'Remoto' },
                    { name: 'cont√©m "nivel 1"', test: queueLower.includes('nivel 1'), expected: 'Remoto' },
                    { name: 'cont√©m "n1"', test: queueLower.includes('n1'), expected: 'Remoto' }
                ];
                
                let matchedRule = null;
                for (const rule of rules) {
                    log(`  ${rule.name}: ${rule.test ? '‚úÖ MATCH' : '‚ùå NO MATCH'} ‚Üí ${rule.test ? rule.expected : 'N/A'}`, 
                        rule.test ? 'success' : 'info');
                    if (rule.test && !matchedRule) {
                        matchedRule = rule;
                    }
                }
                
                const expectedResult = alertSystem.getExpectedServiceTypeForQueue(queue);
                log(`Resultado final: "${expectedResult}"`, expectedResult ? 'success' : 'warning');
                
                // PASSO 2: An√°lise da fun√ß√£o detectCurrentServiceType
                log('<br><strong>PASSO 2: detectCurrentServiceType</strong>', 'info');
                
                // Configurar campo de teste
                document.querySelector('#DynamicField_PRITipoAtendimento').value = 'P';
                
                // Testar seletores individuais
                const selectors = [
                    '#DynamicField_PRITipoAtendimento option:checked',
                    '#DynamicField_PRITipoAtendimento',
                    'select[id*="DynamicField"]'
                ];
                
                for (const selector of selectors) {
                    try {
                        const elements = document.querySelectorAll(selector);
                        log(`Seletor "${selector}": ${elements.length} elemento(s)`, 'info');
                        
                        for (let i = 0; i < elements.length; i++) {
                            const el = elements[i];
                            let value = null;
                            
                            if (el.tagName === 'SELECT') {
                                value = el.value;
                                log(`  [${i}] SELECT - value="${value}", selectedIndex=${el.selectedIndex}`, 'info');
                            } else {
                                value = el.value || el.textContent;
                                log(`  [${i}] ${el.tagName} - value="${value}", textContent="${el.textContent}"`, 'info');
                            }
                            
                            // Testar a l√≥gica de mapeamento
                            if (value === 'P') {
                                log(`    ‚úÖ Valor "P" ‚Üí deveria mapear para "Presencial"`, 'success');
                            } else if (value === 'R') {
                                log(`    ‚úÖ Valor "R" ‚Üí deveria mapear para "Remoto"`, 'success');
                            }
                        }
                    } catch (error) {
                        log(`  ‚ùå Erro no seletor "${selector}": ${error.message}`, 'error');
                    }
                }
                
                const detectedResult = alertSystem.detectCurrentServiceType();
                log(`Resultado final: "${detectedResult}"`, detectedResult ? 'success' : 'warning');
                
                // PASSO 3: Compara√ß√£o final
                log('<br><strong>PASSO 3: Compara√ß√£o Final</strong>', 'info');
                log(`Tipo esperado: "${expectedResult}"`, 'info');
                log(`Tipo detectado: "${detectedResult}"`, 'info');
                
                const shouldAlert = expectedResult && detectedResult && expectedResult !== detectedResult;
                log(`Deveria alertar? ${shouldAlert ? 'üö® SIM' : '‚ùå N√ÉO'}`, shouldAlert ? 'warning' : 'info');
                
                if (shouldAlert) {
                    log(`üéØ ESPERADO: Alerta de inconsist√™ncia entre "${detectedResult}" e "${expectedResult}"`, 'warning');
                }
                
            } catch (error) {
                log(`‚ùå ERRO: ${error.message}`, 'error');
            }
        }
        
        // Auto-configurar ao carregar
        window.addEventListener('load', () => {
            document.querySelector('#Dest').value = 'T√©cnico Remoto';
            document.querySelector('#DynamicField_PRITipoAtendimento').value = 'P';
            log('üîß P√°gina carregada. Campos configurados para teste.', 'info');
        });
    </script>
</body>
</html>
