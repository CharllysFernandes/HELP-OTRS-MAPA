<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste QueueValidator - OTRS MAPA</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .test-section {
            background: #f9f9f9;
            padding: 15px;
            border-left: 4px solid #28a745;
            margin: 20px 0;
        }
        
        button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #218838;
        }
        
        .success {
            color: #28a745;
            font-weight: bold;
        }
        
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        
        h1, h2, h3 {
            color: #333;
        }
        
        .simulation-box {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border: 1px dashed #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste de Valida√ß√£o - QueueValidator OTRS MAPA</h1>
        <p><strong>Data:</strong> 11 de agosto de 2025</p>
        <p><strong>Vers√£o:</strong> 2.3.0 - Otimizada com cache DOM, benchmarks e tratamento de erros</p>
    </div>

    <div class="container">
        <h2>üé≠ Simula√ß√£o de Ambiente OTRS</h2>
        <div class="simulation-box">
            <h3>Elementos DOM Simulados do Sistema OTRS</h3>
            
            <!-- Simulando elementos de sele√ß√£o de fila -->
            <div id="Dest_Search" style="display: none;">
                <div class="InputField_Selection">
                    <span class="Text" id="queueSelection">T√©cnico Local - MAPA</span>
                </div>
            </div>
            
            <select id="Dest" style="display: none;">
                <option value="">Selecione...</option>
                <option value="tecnico-local" selected>T√©cnico Local - MAPA</option>
                <option value="tecnico-remoto">T√©cnico Remoto - N√≠vel 1</option>
                <option value="nivel-2">N√≠vel 2 - Suporte</option>
            </select>
            
            <!-- Simulando elementos de servi√ßo -->
            <div id="ServiceID_Search" style="display: none;">
                <input type="text" value="Registro de Requisi√ß√µesx">
                <div>
                    <span>Servi√ßo Atual</span>
                    <div><span><span onclick="removeService()">√ó</span></span></div>
                </div>
            </div>
            
            <!-- Simulando elemento de estado -->
            <div id="Core_UI_AutogeneratedID_1" style="display: none;">
                <label>Estado:</label>
                <span title="Em Atendimento">Estado do Ticket</span>
            </div>
            
            <p><strong>Controles de Simula√ß√£o:</strong></p>
            <button onclick="changeQueue('T√©cnico Local')">Simular: T√©cnico Local</button>
            <button onclick="changeQueue('T√©cnico Remoto - N√≠vel 1')">Simular: T√©cnico Remoto</button>
            <button onclick="changeQueue('N√≠vel 2 - Suporte')">Simular: N√≠vel 2</button>
            <button onclick="changeQueue('')">Simular: Sem Fila</button>
        </div>
    </div>

    <div class="container">
        <h2>üèóÔ∏è Teste 1: Inicializa√ß√£o e Cache DOM</h2>
        <div class="test-section">
            <button onclick="testInitialization()">Testar Inicializa√ß√£o</button>
            <button onclick="testDOMCache()">Testar Cache DOM</button>
            <div id="init-result" class="result"></div>
        </div>
    </div>

    <div class="container">
        <h2>‚ö° Teste 2: Sistema de Benchmark e Performance</h2>
        <div class="test-section">
            <button onclick="testBenchmark()">Testar Benchmark</button>
            <button onclick="testPerformanceMetrics()">Testar M√©tricas</button>
            <div id="benchmark-result" class="result"></div>
        </div>
    </div>

    <div class="container">
        <h2>üõ°Ô∏è Teste 3: Tratamento de Erros</h2>
        <div class="test-section">
            <button onclick="testErrorHandling()">Testar Error Handling</button>
            <button onclick="testLogging()">Testar Sistema de Log</button>
            <div id="error-result" class="result"></div>
        </div>
    </div>

    <div class="container">
        <h2>üéØ Teste 4: Valida√ß√£o de Filas</h2>
        <div class="test-section">
            <button onclick="testQueueDetection()">Testar Detec√ß√£o de Fila</button>
            <button onclick="testQueueValidation()">Testar Valida√ß√£o Completa</button>
            <button onclick="testEventListeners()">Testar Event Listeners</button>
            <div id="validation-result" class="result"></div>
        </div>
    </div>

    <!-- Mock Scripts -->
    <script>
        // Mock ConfigManager
        class MockConfigManager {
            constructor() {
                this.features = { queueValidation: true };
            }
            
            isFeatureEnabled(feature) {
                return this.features[feature] || false;
            }
            
            normalizeUserLevel(level) {
                if (level.includes('T√©cnico Local')) return 'T√©cnico Local';
                if (level.includes('T√©cnico Remoto') || level.includes('N√≠vel 1')) return 'N√≠vel 1';
                if (level.includes('N√≠vel 2')) return 'N√≠vel 2';
                return level.toLowerCase().replace(/\s+/g, '_');
            }
            
            getUserProfile() {
                return 'N√≠vel 1'; // Simular perfil do usu√°rio
            }
            
            compareUserLevels(queueLevel, userProfile) {
                return queueLevel === userProfile;
            }
        }

        // Mock AlertSystem
        class MockAlertSystem {
            constructor() {
                this.alerts = [];
            }
            
            showUserProfileAlert(profile, queue) {
                console.log(`AlertSystem: Perfil ${profile} incompat√≠vel com fila ${queue}`);
                this.alerts.push({ type: 'profile', profile, queue });
            }
            
            showQueueWarning(id, message, queue, profile) {
                console.log(`AlertSystem: ${message}`);
                this.alerts.push({ type: 'warning', id, message, queue, profile });
            }
            
            remove(id) {
                console.log(`AlertSystem: Removendo alerta ${id}`);
                this.alerts = this.alerts.filter(alert => alert.id !== id);
            }
            
            validateAndShowAlerts(configManager, queueValidator) {
                console.log('AlertSystem: Executando valida√ß√£o completa');
            }
        }

        let queueValidator;
        let configManager;
        let alertSystem;

        function log(containerId, message, isError = false) {
            const container = document.getElementById(containerId);
            const className = isError ? 'error' : 'success';
            container.innerHTML += `<span class="${className}">[${new Date().toLocaleTimeString()}]</span> ${message}\n`;
        }

        function changeQueue(queueName) {
            const queueElement = document.getElementById('queueSelection');
            if (queueElement) {
                queueElement.textContent = queueName;
                log('validation-result', `Fila alterada para: "${queueName}"`);
                
                if (queueValidator) {
                    setTimeout(() => queueValidator.validateCurrentQueue(), 100);
                }
            }
        }

        function testInitialization() {
            const container = document.getElementById('init-result');
            container.innerHTML = '';
            
            try {
                configManager = new MockConfigManager();
                alertSystem = new MockAlertSystem();
                queueValidator = new HelpOTRS.QueueValidator(configManager, alertSystem);
                
                log('init-result', '‚úÖ QueueValidator inicializado com sucesso');
                log('init-result', `‚úÖ ConfigManager integrado: ${!!queueValidator.configManager}`);
                log('init-result', `‚úÖ AlertSystem integrado: ${!!queueValidator.alertSystem}`);
                log('init-result', `‚úÖ Cache DOM inicializado: ${queueValidator.domCache instanceof Map}`);
                log('init-result', `‚úÖ Performance metrics inicializado: ${queueValidator.performanceMetrics instanceof Map}`);
                log('init-result', `‚úÖ Debug habilitado: ${queueValidator.isEnabled}`);
                
            } catch (error) {
                log('init-result', `‚ùå Erro na inicializa√ß√£o: ${error.message}`, true);
            }
        }

        function testDOMCache() {
            const container = document.getElementById('init-result');
            
            if (!queueValidator) {
                log('init-result', '‚ùå QueueValidator n√£o inicializado!', true);
                return;
            }
            
            try {
                // Testar cache de elementos
                const element1 = queueValidator.getCachedElement('#Dest_Search');
                log('init-result', `‚úÖ Elemento #Dest_Search encontrado: ${!!element1}`);
                
                // Testar cache hit
                const element2 = queueValidator.getCachedElement('#Dest_Search');
                log('init-result', `‚úÖ Cache hit funcionando: ${element1 === element2}`);
                
                // Testar getDOMElements
                const elements = queueValidator.getDOMElements();
                log('init-result', `‚úÖ getDOMElements executado: ${typeof elements === 'object'}`);
                log('init-result', `‚úÖ Elementos encontrados: destSearch=${!!elements.destSearch}, destSelection=${!!elements.destSelection}`);
                
                // Testar limpeza de cache
                queueValidator.clearDOMCache();
                log('init-result', '‚úÖ Cache DOM limpo com sucesso');
                
            } catch (error) {
                log('init-result', `‚ùå Erro no teste de cache: ${error.message}`, true);
            }
        }

        async function testBenchmark() {
            const container = document.getElementById('benchmark-result');
            container.innerHTML = '';
            
            if (!queueValidator) {
                log('benchmark-result', '‚ùå QueueValidator n√£o inicializado!', true);
                return;
            }
            
            try {
                // Teste de benchmark com opera√ß√£o simples
                const result = await queueValidator.benchmark('teste-operacao', async () => {
                    // Simular opera√ß√£o que demora um pouco
                    await new Promise(resolve => setTimeout(resolve, 5));
                    return queueValidator.getCurrentQueue();
                });
                
                log('benchmark-result', `‚úÖ Benchmark executado: resultado = "${result}"`);
                
                // Verificar se m√©tricas foram salvas
                const metrics = queueValidator.getPerformanceMetrics();
                log('benchmark-result', `‚úÖ M√©tricas salvas: ${Object.keys(metrics).length} entradas`);
                
                if (metrics['teste-operacao']) {
                    const metric = metrics['teste-operacao'];
                    log('benchmark-result', `‚úÖ Dura√ß√£o registrada: ${metric.duration.toFixed(2)}ms`);
                    log('benchmark-result', `‚úÖ Sucesso registrado: ${metric.success}`);
                }
                
            } catch (error) {
                log('benchmark-result', `‚ùå Erro no benchmark: ${error.message}`, true);
            }
        }

        function testPerformanceMetrics() {
            const container = document.getElementById('benchmark-result');
            
            if (!queueValidator) {
                log('benchmark-result', '‚ùå QueueValidator n√£o inicializado!', true);
                return;
            }
            
            try {
                const stats = queueValidator.getStats();
                log('benchmark-result', `‚úÖ Estat√≠sticas obtidas: ${typeof stats === 'object'}`);
                log('benchmark-result', `‚úÖ Cache size: ${stats.cache?.size || 0} entradas`);
                log('benchmark-result', `‚úÖ Performance metrics: ${Object.keys(stats.performance || {}).length} registros`);
                log('benchmark-result', `‚úÖ Current queue: ${stats.currentQueue || 'N√£o detectada'}`);
                
            } catch (error) {
                log('benchmark-result', `‚ùå Erro nas m√©tricas: ${error.message}`, true);
            }
        }

        function testErrorHandling() {
            const container = document.getElementById('error-result');
            container.innerHTML = '';
            
            if (!queueValidator) {
                log('error-result', '‚ùå QueueValidator n√£o inicializado!', true);
                return;
            }
            
            try {
                // Testar m√©todo com erro simulado
                const originalGetElement = queueValidator.getCachedElement;
                queueValidator.getCachedElement = () => {
                    throw new Error('Erro simulado para teste');
                };
                
                // Testar getDOMElements com erro
                const elements = queueValidator.getDOMElements();
                log('error-result', `‚úÖ Error handling funcionando: ${typeof elements === 'object'}`);
                log('error-result', `‚úÖ Fallback seguro: retorna objeto vazio em caso de erro`);
                
                // Restaurar m√©todo original
                queueValidator.getCachedElement = originalGetElement;
                
            } catch (error) {
                log('error-result', `‚ùå Erro no teste de error handling: ${error.message}`, true);
            }
        }

        function testLogging() {
            const container = document.getElementById('error-result');
            
            if (!queueValidator) {
                log('error-result', '‚ùå QueueValidator n√£o inicializado!', true);
                return;
            }
            
            try {
                // Testar diferentes n√≠veis de log
                queueValidator.log('info', 'Teste de log info');
                queueValidator.log('warn', 'Teste de log warning');
                queueValidator.log('error', 'Teste de log error', { detail: 'erro simulado' });
                
                log('error-result', '‚úÖ Sistema de log funcionando (verifique o console)');
                
            } catch (error) {
                log('error-result', `‚ùå Erro no sistema de log: ${error.message}`, true);
            }
        }

        function testQueueDetection() {
            const container = document.getElementById('validation-result');
            container.innerHTML = '';
            
            if (!queueValidator) {
                log('validation-result', '‚ùå QueueValidator n√£o inicializado!', true);
                return;
            }
            
            try {
                // Testar detec√ß√£o de fila atual
                const currentQueue = queueValidator.getCurrentQueue();
                log('validation-result', `‚úÖ Fila atual detectada: "${currentQueue || 'Nenhuma'}"`);
                
                // Testar normaliza√ß√£o de n√≠vel
                const currentLevel = queueValidator.getCurrentQueueLevel();
                log('validation-result', `‚úÖ N√≠vel normalizado: "${currentLevel || 'Nenhum'}"`);
                
                // Testar verifica√ß√µes espec√≠ficas
                const isLocal = queueValidator.isLocalTechnicianQueue();
                const isRemote = queueValidator.isRemoteTechnicianQueue();
                
                log('validation-result', `‚úÖ √â fila t√©cnico local: ${isLocal}`);
                log('validation-result', `‚úÖ √â fila t√©cnico remoto: ${isRemote}`);
                
            } catch (error) {
                log('validation-result', `‚ùå Erro na detec√ß√£o de fila: ${error.message}`, true);
            }
        }

        async function testQueueValidation() {
            const container = document.getElementById('validation-result');
            
            if (!queueValidator) {
                log('validation-result', '‚ùå QueueValidator n√£o inicializado!', true);
                return;
            }
            
            try {
                // Testar valida√ß√£o de compatibilidade
                const validation = await queueValidator.validateQueueCompatibility();
                log('validation-result', `‚úÖ Valida√ß√£o executada: ${validation.validationStatus}`);
                log('validation-result', `   - Fila: ${validation.currentQueue}`);
                log('validation-result', `   - N√≠vel: ${validation.currentQueueLevel}`);
                log('validation-result', `   - Perfil usu√°rio: ${validation.userProfile}`);
                log('validation-result', `   - Compat√≠vel: ${validation.isCompatible}`);
                log('validation-result', `   - Deve mostrar aviso: ${validation.shouldShowWarning}`);
                
                // Testar valida√ß√£o atual
                await queueValidator.validateCurrentQueue();
                log('validation-result', '‚úÖ Valida√ß√£o de fila atual executada');
                
            } catch (error) {
                log('validation-result', `‚ùå Erro na valida√ß√£o: ${error.message}`, true);
            }
        }

        function testEventListeners() {
            const container = document.getElementById('validation-result');
            
            if (!queueValidator) {
                log('validation-result', '‚ùå QueueValidator n√£o inicializado!', true);
                return;
            }
            
            try {
                // Inicializar o validator (configura event listeners)
                queueValidator.init();
                log('validation-result', '‚úÖ QueueValidator inicializado com event listeners');
                
                // Simular mudan√ßa de fila para testar debouncing
                changeQueue('T√©cnico Remoto - N√≠vel 1');
                setTimeout(() => {
                    changeQueue('N√≠vel 2 - Suporte');
                }, 100);
                
                setTimeout(() => {
                    log('validation-result', '‚úÖ Event listeners com debouncing testados');
                }, 1000);
                
            } catch (error) {
                log('validation-result', `‚ùå Erro nos event listeners: ${error.message}`, true);
            }
        }

        function removeService() {
            console.log('Servi√ßo removido via simula√ß√£o');
        }

        // Cleanup ao sair da p√°gina
        window.addEventListener('beforeunload', () => {
            if (queueValidator) {
                queueValidator.dispose();
            }
        });
    </script>

    <!-- Carregando scripts necess√°rios -->
    <script src="../../src/modules/QueueValidator.js"></script>

    <div class="container">
        <h2>üìä Resultado Final</h2>
        <div class="test-section">
            <p><strong>Status das melhorias implementadas:</strong></p>
            <ul>
                <li>‚úÖ Sistema de Cache DOM Inteligente</li>
                <li>‚úÖ Sistema de Benchmark e M√©tricas de Performance</li>
                <li>‚úÖ Tratamento de Erros Robusto</li>
                <li>‚úÖ Otimiza√ß√£o Arquitetural e Extensibilidade</li>
            </ul>
            
            <button onclick="
                console.log('=== EXECU√á√ÉO AUTOM√ÅTICA DE TODOS OS TESTES ===');
                testInitialization(); 
                setTimeout(() => testDOMCache(), 500);
                setTimeout(() => testBenchmark(), 1000);
                setTimeout(() => testErrorHandling(), 1500);
                setTimeout(() => testQueueDetection(), 2000);
                setTimeout(() => testQueueValidation(), 2500);
            ">üöÄ Executar Todos os Testes</button>
        </div>
    </div>
</body>
</html>
