<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste CKEditor - Znuny/OTRS</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .editor-container {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }
        .cke_wysiwyg_frame {
            width: 100%;
            height: 300px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: white;
        }
        .test-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .test-btn {
            background: linear-gradient(135deg, #FF6B6B, #4ECDC4);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        .results {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            color: #00FF88;
            max-height: 200px;
            overflow-y: auto;
        }
        .form-fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        label {
            margin-bottom: 8px;
            font-weight: 600;
            opacity: 0.9;
        }
        input {
            padding: 12px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
        }
        input::placeholder {
            color: rgba(255,255,255,0.6);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste CKEditor - Znuny/OTRS</h1>
        
        <div class="editor-container">
            <h2>üìù Editor CKEditor Simulado</h2>
            <p>Este teste simula o iframe CKEditor usado pelo Znuny/OTRS:</p>
            
            <!-- Simular iframe do CKEditor como descrito pelo usu√°rio -->
            <iframe 
                id="testCKEditor"
                src="" 
                frameborder="0" 
                class="cke_wysiwyg_frame cke_reset" 
                title="Editor, RichText" 
                aria-describedby="cke_48" 
                tabindex="0" 
                allowtransparency="true" 
                style="width: 100%; height: 300px;">
            </iframe>
        </div>

        <div class="editor-container">
            <h2>üìã Campos de Formul√°rio</h2>
            <div class="form-fields">
                <div class="form-group">
                    <label for="CustomerUser">üë§ Usu√°rio Cliente:</label>
                    <input type="text" id="CustomerUser" placeholder="joao.silva@empresa.com" value="joao.silva@empresa.com">
                </div>
                <div class="form-group">
                    <label for="CustomerID">üè¢ ID do Cliente:</label>
                    <input type="text" id="CustomerID" placeholder="EMP001" value="EMP001">
                </div>
                <div class="form-group">
                    <label for="DynamicField_PRIRamal">üìû Ramal:</label>
                    <input type="text" id="DynamicField_PRIRamal" placeholder="1234" value="1234">
                </div>
                <div class="form-group">
                    <label for="DynamicField_PRILocalidade">üìç Localidade:</label>
                    <input type="text" id="DynamicField_PRILocalidade" placeholder="Bras√≠lia - DF" value="Bras√≠lia - DF">
                </div>
                <div class="form-group">
                    <label for="DynamicField_PRIPatrimonio">üíº Patrim√¥nio:</label>
                    <input type="text" id="DynamicField_PRIPatrimonio" placeholder="PAT123456" value="PAT123456">
                </div>
                <div class="form-group">
                    <label for="DynamicField_PRISala">üè† Sala:</label>
                    <input type="text" id="DynamicField_PRISala" placeholder="Sala 101" value="Sala 101">
                </div>
            </div>
        </div>

        <div class="editor-container">
            <h2>üß™ Testes da Funcionalidade</h2>
            <div class="test-buttons">
                <button class="test-btn" onclick="testFindEditor()">üîç Detectar Editor</button>
                <button class="test-btn" onclick="testCaptureData()">üìã Capturar Dados</button>
                <button class="test-btn" onclick="testInsertData()">üìù Inserir Dados</button>
                <button class="test-btn" onclick="testEditorReady()">‚è≥ Editor Pronto?</button>
                <button class="test-btn" onclick="testFullFlow()">üöÄ Teste Completo</button>
                <button class="test-btn" onclick="clearResults()">üóëÔ∏è Limpar</button>
            </div>
            
            <h3>üìä Resultados dos Testes:</h3>
            <div class="results" id="testResults">Clique nos bot√µes acima para executar os testes...
            </div>
        </div>
    </div>

    <script>
        // Simular a classe FormDataReuser (vers√£o simplificada para teste)
        class TestFormDataReuser {
            constructor() {
                this.targetEditor = null;
                this.formData = {};
            }

            getFieldMappings() {
                return {
                    'CustomerUser': { label: 'üë§ Usu√°rio Cliente', category: 'cliente' },
                    'CustomerID': { label: 'üè¢ ID do Cliente', category: 'cliente' },
                    'DynamicField_PRIRamal': { label: 'üìû Ramal', category: 'contato' },
                    'DynamicField_PRILocalidade': { label: 'üìç Localidade', category: 'localizacao' },
                    'DynamicField_PRIPatrimonio': { label: 'üíº Patrim√¥nio', category: 'patrimonio' },
                    'DynamicField_PRISala': { label: 'üè† Sala', category: 'localizacao' }
                };
            }

            findTextEditor() {
                const selectors = [
                    'iframe.cke_wysiwyg_frame',
                    'iframe[title*="Editor"]',
                    'iframe[title*="RichText"]', 
                    'iframe[class*="cke"]'
                ];

                for (const selector of selectors) {
                    const editor = document.querySelector(selector);
                    if (editor) {
                        try {
                            const iframeDoc = editor.contentDocument || editor.contentWindow.document;
                            if (iframeDoc && iframeDoc.body) {
                                return editor;
                            }
                        } catch (e) {
                            console.log('Iframe inacess√≠vel:', selector);
                        }
                    }
                }
                return null;
            }

            async waitForEditorReady(editor, maxAttempts = 5) {
                if (!editor || editor.tagName !== 'IFRAME') {
                    return editor;
                }

                for (let attempt = 0; attempt < maxAttempts; attempt++) {
                    try {
                        const iframeDoc = editor.contentDocument || editor.contentWindow.document;
                        if (iframeDoc && iframeDoc.body && iframeDoc.readyState === 'complete') {
                            return editor;
                        }
                    } catch (e) {
                        console.log('Tentativa', attempt + 1, 'falhou');
                    }
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
                return editor;
            }

            captureFormData() {
                const mappings = this.getFieldMappings();
                const capturedData = {};

                Object.keys(mappings).forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    const mapping = mappings[fieldId];
                    
                    if (field && field.value.trim()) {
                        capturedData[fieldId] = {
                            label: mapping.label,
                            value: field.value.trim(),
                            category: mapping.category
                        };
                    }
                });

                this.formData = capturedData;
                return Object.keys(capturedData).length > 0;
            }

            async insertDataIntoEditor(item) {
                let editor = this.targetEditor;
                if (!editor) return;

                if (editor.tagName === 'IFRAME') {
                    editor = await this.waitForEditorReady(editor, 3);
                }

                try {
                    if (editor.tagName === 'IFRAME') {
                        const iframeDoc = editor.contentDocument || editor.contentWindow.document;
                        const body = iframeDoc.body;
                        
                        if (body) {
                            editor.contentWindow.focus();
                            
                            const dataElement = iframeDoc.createElement('div');
                            dataElement.innerHTML = `<strong>${item.label}:</strong> ${item.value}`;
                            dataElement.style.marginBottom = '5px';
                            
                            if (body.innerHTML.trim() === '' || body.innerHTML === '<p><br></p>') {
                                body.innerHTML = '';
                                body.appendChild(dataElement);
                            } else {
                                const breakElement = iframeDoc.createElement('br');
                                body.appendChild(breakElement);
                                body.appendChild(dataElement);
                            }
                            
                            const finalBreak = iframeDoc.createElement('br');
                            body.appendChild(finalBreak);
                            
                            return true;
                        }
                    }
                } catch (error) {
                    console.error('Erro ao inserir:', error);
                    return false;
                }
                return false;
            }
        }

        // Inst√¢ncia para testes
        const tester = new TestFormDataReuser();

        // Configurar iframe do CKEditor com conte√∫do edit√°vel
        window.addEventListener('load', () => {
            const iframe = document.getElementById('testCKEditor');
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            
            iframeDoc.open();
            iframeDoc.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            margin: 10px; 
                            padding: 0; 
                            background: white; 
                            color: black;
                        }
                        div { margin-bottom: 5px; }
                        strong { color: #0066cc; }
                    </style>
                </head>
                <body contenteditable="true">
                    <p>Clique aqui para editar... Os dados inseridos aparecer√£o aqui!</p>
                </body>
                </html>
            `);
            iframeDoc.close();
            
            logResult('‚úÖ CKEditor simulado configurado e pronto!');
        });

        // Fun√ß√µes de teste
        function testFindEditor() {
            const editor = tester.findTextEditor();
            if (editor) {
                tester.targetEditor = editor;
                logResult(`‚úÖ Editor encontrado: ${editor.className || editor.tagName}`);
                logResult(`   - Tipo: ${editor.tagName}`);
                logResult(`   - Classes: ${editor.className}`);
                logResult(`   - T√≠tulo: ${editor.title}`);
            } else {
                logResult('‚ùå Editor n√£o encontrado');
            }
        }

        function testCaptureData() {
            const captured = tester.captureFormData();
            if (captured) {
                logResult(`‚úÖ Dados capturados: ${Object.keys(tester.formData).length} campos`);
                Object.values(tester.formData).forEach(data => {
                    logResult(`   - ${data.label}: ${data.value}`);
                });
            } else {
                logResult('‚ùå Nenhum dado capturado');
            }
        }

        async function testInsertData() {
            if (!tester.targetEditor) {
                logResult('‚ùå Execute "Detectar Editor" primeiro');
                return;
            }

            if (Object.keys(tester.formData).length === 0) {
                logResult('‚ùå Execute "Capturar Dados" primeiro');
                return;
            }

            const firstItem = Object.values(tester.formData)[0];
            const success = await tester.insertDataIntoEditor(firstItem);
            
            if (success) {
                logResult(`‚úÖ Dados inseridos: ${firstItem.label}`);
            } else {
                logResult(`‚ùå Falha ao inserir: ${firstItem.label}`);
            }
        }

        async function testEditorReady() {
            if (!tester.targetEditor) {
                logResult('‚ùå Execute "Detectar Editor" primeiro');
                return;
            }

            logResult('‚è≥ Testando se editor est√° pronto...');
            const readyEditor = await tester.waitForEditorReady(tester.targetEditor);
            
            if (readyEditor) {
                try {
                    const iframeDoc = readyEditor.contentDocument || readyEditor.contentWindow.document;
                    logResult(`‚úÖ Editor pronto!`);
                    logResult(`   - ReadyState: ${iframeDoc.readyState}`);
                    logResult(`   - Body presente: ${!!iframeDoc.body}`);
                    logResult(`   - Edit√°vel: ${iframeDoc.body?.contentEditable !== 'false'}`);
                } catch (e) {
                    logResult(`‚ùå Editor n√£o acess√≠vel: ${e.message}`);
                }
            } else {
                logResult('‚ùå Editor n√£o est√° pronto');
            }
        }

        async function testFullFlow() {
            logResult('üöÄ Iniciando teste completo...');
            logResult('');
            
            // 1. Detectar editor
            testFindEditor();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 2. Capturar dados
            testCaptureData();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 3. Verificar se editor est√° pronto
            await testEditorReady();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 4. Inserir todos os dados
            if (tester.targetEditor && Object.keys(tester.formData).length > 0) {
                logResult('üìù Inserindo todos os dados...');
                for (const item of Object.values(tester.formData)) {
                    await tester.insertDataIntoEditor(item);
                    logResult(`   ‚úÖ ${item.label} inserido`);
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
                logResult('üéâ Teste completo finalizado!');
            }
        }

        function clearResults() {
            document.getElementById('testResults').textContent = 'Resultados limpos. Execute os testes novamente...';
        }

        function logResult(message) {
            const results = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();
            results.textContent += `[${timestamp}] ${message}\n`;
            results.scrollTop = results.scrollHeight;
        }
    </script>
</body>
</html>
